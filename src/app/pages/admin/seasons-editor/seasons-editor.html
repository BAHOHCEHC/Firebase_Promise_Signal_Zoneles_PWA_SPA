<div class="page-container">

  <!-- Header -->
  <div class="header-actions">
    <div class="actions-right">
      <button class="btn btn-warning" (click)="onReset()">
        Reset â†º
      </button>

      <button class="btn btn-save" (click)="onSavePage()">
        Save ðŸ’¾
      </button>
    </div>
  </div>

  <!-- ================= CHARACTERS ================= -->
  <div class="content-section">
    <h2>Characters</h2>

    <!-- Element Requirements -->
    <div class="element-req-section">
      <div class="label-row">
        <span>This season Elemental Type Requirements:</span>

        @if (activeElements().size === 0) {
        <button class="btn-icon" (click)="openElementModal()">
          ?
        </button>
        }

        @if (activeElements().size > 0) {
        <div class="selected-elements">
          @for (el of elementTypes; track el) {
          @if (activeElements().has(el)) {
          <button class="element-btn-mini" (click)="openElementModal()">
            <img [src]="getElementIconPath(el)" [alt]="el" />
          </button>
          }
          }
        </div>
        }
      </div>
    </div>

    <!-- Opening Characters -->
    <div class="characters-blocks">

      <div class="char-block">
        <h3>Opening characters</h3>

        <div class="char-list">
          @for (char of seasonDetails().opening_characters; track char.id) {
          <div class="char-mini-card">
            <img [src]="resolveAvatarUrl(char.id)" [alt]="char.name" [style.background-image]="'url(' + char.rarity.bgUrl + ')'"/>

            @if (char.element) {
            <div class="element-mini-badge">
              <img [src]="getElementIconPath(char.element.name)" />
            </div>
            }
          </div>
          }

          @if (seasonDetails().opening_characters.length === 0) {
          <button class="add-char-btn" (click)="openCharacterModal('opening')">
            +
          </button>
          } @else {
          <button class="add-char-btn" (click)="openCharacterModal('opening')">
            <span class="material-symbols-outlined">
              refresh
            </span>
          </button>
          }
        </div>
      </div>

      <!-- Special Guests -->
      <div class="char-block">
        <h3>Special guests</h3>

        <div class="char-list">
          @for (char of seasonDetails().special_guests; track char.id) {
          <div class="char-mini-card">
            <img [src]="resolveAvatarUrl(char.id)" [alt]="char.name" [style.background-image]="'url(' + char.rarity.bgUrl + ')'"/>
            @if (char.element) {
            <div class="element-mini-badge">
              <img [src]="getElementIconPath(char.element.name)" />
            </div>
            }
          </div>
          }

          @if (seasonDetails().special_guests.length === 0) {
          <button class="add-char-btn" (click)="openCharacterModal('special')">
            +
          </button>
          } @else {
          <button class="add-char-btn" (click)="openCharacterModal('special')">
            <span class="material-symbols-outlined">
              refresh
            </span>
          </button>
          }
        </div>
      </div>

    </div>
  </div>

  <!-- ================= ACTS ================= -->
  <div class="content-section">
    <h2>This season Act Battle cards variations</h2>

    <!-- Boss & Arcana -->
    <!-- ================= Boss Chambers ================= -->
    @if (bossActs().length) {
    <div class="subsection">
      <h3>Boss Chambers</h3>

      <div class="acts-grid">
        @for (act of bossActs(); track act.id) {
        <div class="act-card">
          <div class="act-header">
            Act {{ act.name }}
          </div>

          <div class="enemies-container-wrapper">
            @if (act.enemy_options?.timer) {
            <div class="act-options-info">
              {{ act.enemy_options?.timer }} sec
            </div>
            }

            <div class="enemies-container">
              <!-- Boss usually has 1 variation, 1 wave -->
              @if (act.variations && act.variations[0]?.waves) {
              @for (wave of act.variations[0].waves; track $index) {
              <div class="enemy-inner">
                @for (enemy of wave.included_enemy; track enemy.id) {
                @if (enemy.quantity > 1) {
                <span class="badge badge-amount">{{ enemy.quantity }}</span>
                }
                @if (enemy.specialMark) {
                <span class="badge badge-specialMark"><img src="assets/images/specia_mark.svg" /></span>
                }
                <div class="enemy-circle">
                  <img [src]="resolveAvatarUrl(enemy.id)" />
                </div>
                }
              </div>
              }
              }

              @if (!act.enemy_selection.length) {
              <button class="btn-add-circle" (click)="openAddEnemyModal(act)">
                +
              </button>
              } @else {
              <button class="btn-add-circle" (click)="openAddEnemyModal(act)">
                <span class="material-symbols-outlined">
                  refresh
                </span>
              </button>
              }
            </div>
          </div>
        </div>
        }
      </div>
    </div>
    }

    <!-- ================= Arcana Chambers ================= -->
    @if (arcanaActs().length) {
    <div class="subsection">
      <h3>Arcana Chambers</h3>

      <div class="acts-grid acts-grid-arcana">
        @for (act of arcanaActs(); track act.id) {
        <div class="act-card arcana">
          <div class="act-header">
            Arcana {{ act.name }}
          </div>

          <div class="enemies-container-wrapper">
            @if (act.enemy_options?.timer) {
            <div class="act-options-info">
              {{ act.enemy_options?.timer }} sec
            </div>
            }
            <div class="enemies-container">
              <!-- Arcana usually has 1 variation, 1 wave -->
              @if (act.variations && act.variations[0]?.waves) {
              @for (wave of act.variations[0].waves; track $index) {
              <div class="enemy-inner">
                @for (enemy of wave.included_enemy; track enemy.id) {
                @if (enemy.quantity > 1) {
                <span class="badge badge-amount">{{ enemy.quantity }}</span>
                }
                @if (enemy.specialMark) {
                <span class="badge badge-specialMark"><img src="assets/images/specia_mark.svg" /></span>
                }
                <div class="enemy-circle">
                  <img [src]="resolveAvatarUrl(enemy.id)" />
                </div>
                }
              </div>
              }
              }

              @if (!act.enemy_selection.length) {
              <button class="btn-add-circle" (click)="openAddEnemyModal(act)">
                +
              </button>
              } @else {
              <button class="btn-add-circle" (click)="openAddEnemyModal(act)">
                <span class="material-symbols-outlined">
                  refresh
                </span>
              </button>
              }
            </div>
          </div>
        </div>
        }
      </div>
    </div>
    }

    <!-- ================= VARIATIONS ================= -->
    <div class="subsection">
      <h3>Variation Chambers</h3>

      <div class="variations-grid">
        @for (act of variationActs(); track act.id) {
        <div class="variation-card">
          <div class="var-header">
            Act {{ act.name }}
          </div>

          <div class="var-content">
            @if (act.type == "Variation_fight") {
            <div class="var-settings-display">
              <div class="var-waves-container">
                @for (variation of act.variations; track $index; let vIdx = $index) {
                <div class="variation-row">
                  <div class="variation-number">
                    <div class="span fs_16">
                      {{$index + 1 + '.'}}
                    </div>
                  </div>
                  <!-- Timer -->
                  @if (variation.timer) {
                  <div class="wave-timer">
                    {{ variation.timer }} sec
                  </div>
                  }
                  <!-- Monolit -->
                  @if (variation.monolit) {
                  <div class="wave-timer">
                    Monolit
                  </div>
                  }

                  <div class="wave-column-wrapper">
                    @for (wave of variation.waves; track $index; let wIdx = $index) {
                    <div class="wave-column">
                      <!-- Wave title -->
                      <div class="wave-header">
                        @if (variation.wave === 'custom') {
                        {{ variation.name || 'Custom wave' }}
                        } @else {
                        Wave {{ wIdx + 1 }}
                        }
                      </div>

                      <!-- Enemies -->
                      <div class="enemies-vertical-list">
                        <div class="enemy-inner">
                          @for (enemy of wave.included_enemy; track enemy.id) {
                          @if (enemy.quantity > 1) {
                          <span class="badge badge-amount">
                            {{ enemy.quantity }}
                          </span>
                          }
                          @if (enemy.specialMark) {
                          <span class="badge badge-specialMark"><img src="assets/images/specia_mark.svg" /></span>
                          }
                          <div class="enemy-circle">
                            <img [src]="resolveAvatarUrl(enemy.id)" [alt]="enemy.name" />
                          </div>
                          }

                        </div>
                        @if (wave.included_enemy.length === 0) {
                        <button class="btn-add-circle small" (click)="openAddEnemyToWave(act, vIdx, wIdx)">
                          +
                        </button>
                        } @else {
                        <button class="btn-add-circle small" (click)="openAddEnemyToWave(act, vIdx, wIdx)">
                          <span class="material-symbols-outlined">
                            refresh
                          </span>
                        </button>
                        }
                      </div>
                    </div>
                    }
                  </div>

                  <button class="btn-edit-settings" (click)="openVariationModal(act, vIdx)">
                    <span class="material-symbols-outlined">
                      settings_b_roll
                    </span>
                  </button>
                </div>
                }
              </div>

            </div>
            }
            <button class="btn-cta" (click)="openVariationModal(act)">
              + Add variation
            </button>
          </div>
        </div>
        }
      </div>
    </div>
  </div>

  <!-- ================= MODALS ================= -->

  @if (showElementModal()) {
  <app-season-element-type-modal [selectedElements]="seasonDetails().elemental_type_limided"
    (close)="closeElementModal()" (save)="onSaveElements($event)" />
  }

  @if (showCharactersModal()) {
  <app-season-characters-modal [title]="currentCharacterTitle()" [limit]="currentCharacterLimit()"
    [allCharacters]="allCharacters()" [startSelection]="currentCharacterSelection()" (close)="closeCharacterModal()"
    (save)="onSaveCharacters($event)" />
  }

  @if (showAddEnemyModal()) {
  <app-season-add-enemy-modal [actOptions]="currentActOptions()" [categories]="enemiesService.categories()"
    [allEnemies]="enemiesService.enemies()" [initialEnemies]="currentInitialEnemies()"
    [initialOptions]="currentInitialOptions()" [currentAct]="currentActForEnemy()"
    [currentVariation]="currentVariationForEnemy()" [currentWave]="currentWaveForEnemy()" (close)="closeAddEnemyModal()"
    (save)="onSaveEnemy($event)" />
  }

  @if (showVariationModal()) {
  <season-add-variation-chamber-modal [initialData]="currentInitialVariation()" (close)="closeVariationModal()"
    (save)="onSaveVariation($event)" />
  }

</div>
