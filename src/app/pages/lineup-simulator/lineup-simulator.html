<section class="page-container">
  <!-- Стан завантаження -->
  @if (loading()) {
    <div class="loading-state">
      <span class="material-symbols-outlined spin">progress_activity</span>
      <p>Loading data...</p>
    </div>
  } @else {
    <div
      class="lineup_wrapper"
      #screenshotRoot
    >
      <!-- ================= CHARACTERS ================= -->
      <div class="left-section">
        <h2>Characters</h2>
        <!-- Opening Characters -->
        <div class="characters-blocks">
          <div class="char-block">
            <h3>Opening characters</h3>
            <div class="char-list">
              @for (char of openingCharacters(); track char.id) {
                <div
                  class="char-mini-card dragableSection"
                  [draggable]="char.energy > 0"
                  (dragstart)="onDragStart($event, char)"
                  [class.tired]="char.energy === 0"
                >
                  <img
                    [src]="resolveAvatarUrl(char.id)"
                    [alt]="char.name"
                    [style.background-image]="'url(' + char.rarity.bgUrl + ')'"
                  />

                  @if (char.element) {
                    <div class="element-badge">
                      <img
                        [src]="getElementIconPath(char.element.name)"
                        [alt]="char.element.name"
                      />
                    </div>
                  }
                  @if (char.energy) {
                    <div class="energy-badge">
                      <span class="energy">
                        {{ char.energy }}
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="8"
                          height="12"
                          viewBox="0 0 8 12"
                          fill="none"
                        >
                          <path
                            d="M0.428278 5.91034C-0.112724 5.51744 -0.146829 4.75663 0.357065 4.3217L5.18785 0.152051C5.39686 -0.0283587 5.70875 -0.0506819 5.944 0.0979289C6.18844 0.252338 6.28363 0.548854 6.17131 0.806026L5.03391 3.41026C4.8498 3.8318 4.97831 4.31781 5.35044 4.60738L7.51943 6.29511C8.05384 6.71095 8.052 7.48629 7.51562 7.89985L3.01426 11.3704C2.81445 11.5244 2.52821 11.5255 2.32717 11.3729C2.12891 11.2224 2.06621 10.9623 2.17582 10.7452L3.11023 8.89442C3.33338 8.45244 3.19933 7.92281 2.78888 7.62472L0.428278 5.91034Z"
                            fill="#FFEF3C"
                          />
                        </svg>
                      </span>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>
        <!-- Element Requirements -->
        <div class="element-req-section">
          <div class="label-row">
            <span>This season Elemental Type Requirements:</span>
            @if (activeElements().size > 0) {
              <div class="selected-elements">
                @for (el of elementTypes; track el) {
                  @if (activeElements().has(el)) {
                    <img
                      [src]="getElementIconPath(el)"
                      [alt]="el"
                    />
                  }
                }
              </div>
            }
          </div>
        </div>

        <div class="container_alternate_cast">
          @if (modes().length) {
            <label for="mode">Alternate cast</label>

            <div class="mode_selector">
              <select
                id="mode"
                class="form-control"
                [value]="store.activeModeId()"
                (change)="onModeChange($event)"
              >
                @for (mode of modes(); track mode.id) {
                  <option [value]="mode.id">{{ mode.name }}</option>
                }
              </select>

              <div class="mode_limit">
                <span class="fs_14">
                  <!-- {{ activeMode()?.min_characters }} / {{ activeMode()?.max_characters }} -->
                  {{ usersCharacter().length }} / {{ activeMode()?.max_characters }}
                </span>
              </div>

              <button
                type="button"
                class="btn-cta"
                (click)="openAlternateCastModal()"
              >
                + Add characters
              </button>
            </div>
          }
        </div>

        <div class="user_characters_list">
          <div class="char-list">
            @if (!usersCharacter().length) {
              <div class="chars_empty_msg fs_14">
                <span>Empty. Please select your cast first</span>
              </div>
            }

            @for (char of usersCharacter(); track char.id) {
              <div
                class="char-mini-card dragableSection"
                [draggable]="char.energy > 0"
                (dragstart)="onDragStart($event, char)"
                [class.tired]="char.energy === 0"
              >
                <img
                  [src]="resolveAvatarUrl(char.id)"
                  [alt]="char.name"
                  [style.background-image]="'url(' + char.rarity.bgUrl + ')'"
                />

                @if (char.element) {
                  <div class="element-badge">
                    <img [src]="getElementIconPath(char.element.name)" />
                  </div>
                }
                @if (char.energy) {
                  <div class="energy-badge">
                    <span class="energy">
                      {{ char.energy }}
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="8"
                        height="12"
                        viewBox="0 0 8 12"
                        fill="none"
                      >
                        <path
                          d="M0.428278 5.91034C-0.112724 5.51744 -0.146829 4.75663 0.357065 4.3217L5.18785 0.152051C5.39686 -0.0283587 5.70875 -0.0506819 5.944 0.0979289C6.18844 0.252338 6.28363 0.548854 6.17131 0.806026L5.03391 3.41026C4.8498 3.8318 4.97831 4.31781 5.35044 4.60738L7.51943 6.29511C8.05384 6.71095 8.052 7.48629 7.51562 7.89985L3.01426 11.3704C2.81445 11.5244 2.52821 11.5255 2.32717 11.3729C2.12891 11.2224 2.06621 10.9623 2.17582 10.7452L3.11023 8.89442C3.33338 8.45244 3.19933 7.92281 2.78888 7.62472L0.428278 5.91034Z"
                          fill="#FFEF3C"
                        />
                      </svg>
                    </span>
                  </div>
                }
              </div>
            }
          </div>
          @if (!!usersCharacter().length) {
            <div class="btn_wrapper">
              <button
                type="button"
                class="btn-save"
                (click)="saveConfiguration()"
              >
                <span class="material-symbols-outlined"> download </span>
                Save your config
              </button>
            </div>
          }
        </div>
      </div>

      <div class="right-section">
        <h2>Lineup simulator</h2>

        <div class="act-section">
          <div class="act-left-column">
            @for (act of leftActs(); track act.id) {
              <div class="act-item">
                <div class="act-section-name">
                  <h3>Act {{ act.name }}</h3>
                </div>
                <div class="act-section-inner">
                  <div class="act-section-enemy">
                    <!-- Element requirements or what? Design shows element icons or boss icons? -->
                    <!-- Design shows some enemies. -->
                    @for (enemy of getActEnemies(act); track $index) {
                      <img
                        [src]="resolveAvatarUrl(enemy)"
                        [alt]="enemy.name"
                        [title]="enemy.name"
                        (click)="onSelectEnemy(act.id, $index)"
                        [class.active]="isEnemyActive(act.id, $index)"
                        [class.inactive]="!isEnemyActive(act.id, $index)"
                      />
                    }
                  </div>
                  <div
                    class="act-section-dragNdrop"
                    (dragover)="onDragOver($event)"
                    (drop)="onDrop($event, act.id)"
                  >
                    <!-- Placed Characters -->
                    @for (char of getPlacedCharacters(act.id); track char.id) {
                      <div
                        class="char-mini-card placed-char"
                        (click)="onRemoveCharacter(act.id, char.id)"
                        title="Click to remove"
                        [style.background-image]="'url(' + char.rarity.bgUrl + ')'"
                      >
                        <img
                          [src]="resolveAvatarUrl(char)"
                          [alt]="char.name"
                        />
                        @if (char.element) {
                          <div class="element-badge">
                            <img
                              [src]="getElementIconPath(char.element.name)"
                              [alt]="char.element.name"
                            />
                          </div>
                        }
                      </div>
                    }

                    <!-- Placeholder Icon -->
                    @if (getPlacedCharacters(act.id).length < 4) {
                      <div class="svg_wrap">
                        <svg
                          class="drop-icon"
                          xmlns="http://www.w3.org/2000/svg"
                          width="30"
                          height="29"
                          viewBox="0 0 30 29"
                          fill="none"
                        >
                          <path
                            fill-rule="evenodd"
                            clip-rule="evenodd"
                            d="M0 1.36703V2.73405H1.37957H2.75914V1.36703V0H1.37957H0V1.36703ZM5.58398 1.36703V2.73405H6.99639H8.40881V1.36703V0H6.99639H3.58398V1.36703ZM11.168 1.36703V2.73405H12.5804H13.9928V1.36703V0H12.5804H11.168V1.36703ZM16.8176 1.36703V2.73405H18.1972H19.5768V1.36703V0H18.1972H16.8176V1.36703ZM0 6.93277V8.33235H1.37957H2.75914V6.93277V5.5332H1.37957H0V6.93277ZM16.8025 6.9165L16.7848 8.2998L13.0402 8.33235L9.29568 8.36489L9.04493 8.51937C8.90697 8.60432 8.71481 8.79258 8.61792 8.93768L8.44166 9.20152L8.40881 12.9168L8.37597 16.6321L6.97997 16.6497L5.58398 16.6673V18.0317V19.3961L6.97997 19.4137L8.37597 19.4313L8.40881 23.1525L8.44166 26.8738L8.63874 27.151C8.74714 27.3034 8.96609 27.4964 9.12533 27.5796L9.41491 27.7311H13.1162H16.8176V26.3648V24.9984L14.0092 24.9815L11.2008 24.9645V18.0317V11.0989H18.1972H25.1936L25.2109 13.1658L25.2283 15.2326H26.6069H27.9856V12.2809V9.3293L27.8327 9.04235C27.7487 8.88456 27.554 8.66759 27.4001 8.56018L27.1204 8.36489L23.365 8.33235L19.6096 8.2998L19.5919 6.9165L19.5741 5.5332H18.1972H16.8203L16.8025 6.9165ZM0 12.466V13.8655H1.37957H2.75914V12.466V11.0664H1.37957H0V12.466ZM19.6214 20.8412C19.6429 23.8967 19.6652 26.4028 19.6709 26.4104C19.6766 26.418 20.3696 25.7627 21.211 24.9542C22.0522 24.1457 22.764 23.5097 22.7925 23.5408C22.8211 23.572 23.4727 24.6813 24.2406 26.006C25.0085 27.3307 25.6701 28.4482 25.7108 28.4892C25.7662 28.5451 26.086 28.3906 26.9818 27.8754L28.1789 27.187L28.0576 26.9871C27.0035 25.2481 25.231 22.1051 25.2856 22.0717C25.3239 22.0482 26.2205 21.7858 27.2781 21.4883C28.3357 21.191 29.2229 20.9274 29.2499 20.9026C29.2918 20.864 20.004 15.4458 19.6945 15.3284C19.589 15.2884 19.5846 15.6194 19.6214 20.8412ZM0 18.0317V19.3987H1.37957H2.75914V18.0317V16.6647H1.37957H0V18.0317Z"
                            fill="white"
                            fill-opacity="0.2"
                          />
                        </svg>
                      </div>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
          <div class="act-right-column">
            @for (act of rightActs(); track act.id) {
              <div class="act-item">
                <div class="act-section-name">
                  <h3>Act {{ act.name }}</h3>
                </div>
                <div class="act-section-inner">
                  <div class="act-section-enemy">
                    @for (enemy of getActEnemies(act); track $index) {
                      <img
                        [src]="resolveAvatarUrl(enemy)"
                        [alt]="enemy.name"
                        [title]="enemy.name"
                        (click)="onSelectEnemy(act.id, $index)"
                        [class.active]="isEnemyActive(act.id, $index)"
                        [class.inactive]="!isEnemyActive(act.id, $index)"
                      />
                    }
                  </div>
                  <div
                    class="act-section-dragNdrop"
                    (dragover)="onDragOver($event)"
                    (drop)="onDrop($event, act.id)"
                  >
                    <!-- Placed Characters -->
                    @for (char of getPlacedCharacters(act.id); track char.id) {
                      <div
                        class="char-mini-card placed-char"
                        (click)="onRemoveCharacter(act.id, char.id)"
                        title="Click to remove"
                        [style.background-image]="'url(' + char.rarity.bgUrl + ')'"
                      >
                        <img
                          [src]="resolveAvatarUrl(char)"
                          [alt]="char.name"
                        />
                        @if (char.element) {
                          <div class="element-badge">
                            <img
                              [src]="getElementIconPath(char.element.name)"
                              [alt]="char.element.name"
                            />
                          </div>
                        }
                      </div>
                    }
                    <!-- Placeholder Icon -->
                    @if (getPlacedCharacters(act.id).length < 4) {
                      <div class="svg_wrap">
                        <svg
                          class="drop-icon"
                          xmlns="http://www.w3.org/2000/svg"
                          width="30"
                          height="29"
                          viewBox="0 0 30 29"
                          fill="none"
                        >
                          <path
                            fill-rule="evenodd"
                            clip-rule="evenodd"
                            d="M0 1.36703V2.73405H1.37957H2.75914V1.36703V0H1.37957H0V1.36703ZM5.58398 1.36703V2.73405H6.99639H8.40881V1.36703V0H6.99639H3.58398V1.36703ZM11.168 1.36703V2.73405H12.5804H13.9928V1.36703V0H12.5804H11.168V1.36703ZM16.8176 1.36703V2.73405H18.1972H19.5768V1.36703V0H18.1972H16.8176V1.36703ZM0 6.93277V8.33235H1.37957H2.75914V6.93277V5.5332H1.37957H0V6.93277ZM16.8025 6.9165L16.7848 8.2998L13.0402 8.33235L9.29568 8.36489L9.04493 8.51937C8.90697 8.60432 8.71481 8.79258 8.61792 8.93768L8.44166 9.20152L8.40881 12.9168L8.37597 16.6321L6.97997 16.6497L5.58398 16.6673V18.0317V19.3961L6.97997 19.4137L8.37597 19.4313L8.40881 23.1525L8.44166 26.8738L8.63874 27.151C8.74714 27.3034 8.96609 27.4964 9.12533 27.5796L9.41491 27.7311H13.1162H16.8176V26.3648V24.9984L14.0092 24.9815L11.2008 24.9645V18.0317V11.0989H18.1972H25.1936L25.2109 13.1658L25.2283 15.2326H26.6069H27.9856V12.2809V9.3293L27.8327 9.04235C27.7487 8.88456 27.554 8.66759 27.4001 8.56018L27.1204 8.36489L23.365 8.33235L19.6096 8.2998L19.5919 6.9165L19.5741 5.5332H18.1972H16.8203L16.8025 6.9165ZM0 12.466V13.8655H1.37957H2.75914V12.466V11.0664H1.37957H0V12.466ZM19.6214 20.8412C19.6429 23.8967 19.6652 26.4028 19.6709 26.4104C19.6766 26.418 20.3696 25.7627 21.211 24.9542C22.0522 24.1457 22.764 23.5097 22.7925 23.5408C22.8211 23.572 23.4727 24.6813 24.2406 26.006C25.0085 27.3307 25.6701 28.4482 25.7108 28.4892C25.7662 28.5451 26.086 28.3906 26.9818 27.8754L28.1789 27.187L28.0576 26.9871C27.0035 25.2481 25.231 22.1051 25.2856 22.0717C25.3239 22.0482 26.2205 21.7858 27.2781 21.4883C28.3357 21.191 29.2229 20.9274 29.2499 20.9026C29.2918 20.864 20.004 15.4458 19.6945 15.3284C19.589 15.2884 19.5846 15.6194 19.6214 20.8412ZM0 18.0317V19.3987H1.37957H2.75914V18.0317V16.6647H1.37957H0V18.0317Z"
                            fill="white"
                            fill-opacity="0.2"
                          />
                        </svg>
                      </div>
                    }
                  </div>
                </div>
              </div>
            }
          </div>

          @if (!!arcanaActs().length) {
            <div class="act-arcana-row">
              @for (act of arcanaActs(); track act.id) {
                <div class="act-item arcana">
                  <div class="act-section-name">
                    @if (act.type === 'Arcana_fight') {
                      <h3>Arcana {{ act.name }}</h3>
                    } @else {
                      <h3>Act {{ act.name }}</h3>
                    }
                  </div>
                  <div class="act-section-inner">
                    <div class="act-section-enemy">
                      @for (enemy of getActEnemies(act); track $index) {
                        <img
                          [src]="resolveAvatarUrl(enemy)"
                          [alt]="enemy.name"
                          [title]="enemy.name"
                          (click)="onSelectEnemy(act.id, $index)"
                          [class.active]="isEnemyActive(act.id, $index)"
                          [class.inactive]="!isEnemyActive(act.id, $index)"
                        />
                      }
                    </div>
                    <div
                      class="act-section-dragNdrop"
                      (dragover)="onDragOver($event)"
                      (drop)="onDrop($event, act.id)"
                    >
                      <!-- Placed Characters -->
                      @for (char of getPlacedCharacters(act.id); track char.id) {
                        <div
                          class="char-mini-card placed-char"
                          (click)="onRemoveCharacter(act.id, char.id)"
                          title="Click to remove"
                          [style.background-image]="'url(' + char.rarity.bgUrl + ')'"
                        >
                          <img
                            [src]="resolveAvatarUrl(char)"
                            [alt]="char.name"
                          />
                          @if (char.element) {
                            <div class="element-badge">
                              <img [src]="getElementIconPath(char.element.name)" />
                            </div>
                          }
                        </div>
                      }

                      <!-- Placeholder Icon -->
                      @if (getPlacedCharacters(act.id).length < 4) {
                        <div class="svg_wrap">
                          <svg
                            class="drop-icon"
                            xmlns="http://www.w3.org/2000/svg"
                            width="30"
                            height="29"
                            viewBox="0 0 30 29"
                            fill="none"
                          >
                            <path
                              fill-rule="evenodd"
                              clip-rule="evenodd"
                              d="M0 1.36703V2.73405H1.37957H2.75914V1.36703V0H1.37957H0V1.36703ZM5.58398 1.36703V2.73405H6.99639H8.40881V1.36703V0H6.99639H3.58398V1.36703ZM11.168 1.36703V2.73405H12.5804H13.9928V1.36703V0H12.5804H11.168V1.36703ZM16.8176 1.36703V2.73405H18.1972H19.5768V1.36703V0H18.1972H16.8176V1.36703ZM0 6.93277V8.33235H1.37957H2.75914V6.93277V5.5332H1.37957H0V6.93277ZM16.8025 6.9165L16.7848 8.2998L13.0402 8.33235L9.29568 8.36489L9.04493 8.51937C8.90697 8.60432 8.71481 8.79258 8.61792 8.93768L8.44166 9.20152L8.40881 12.9168L8.37597 16.6321L6.97997 16.6497L5.58398 16.6673V18.0317V19.3961L6.97997 19.4137L8.37597 19.4313L8.40881 23.1525L8.44166 26.8738L8.63874 27.151C8.74714 27.3034 8.96609 27.4964 9.12533 27.5796L9.41491 27.7311H13.1162H16.8176V26.3648V24.9984L14.0092 24.9815L11.2008 24.9645V18.0317V11.0989H18.1972H25.1936L25.2109 13.1658L25.2283 15.2326H26.6069H27.9856V12.2809V9.3293L27.8327 9.04235C27.7487 8.88456 27.554 8.66759 27.4001 8.56018L27.1204 8.36489L23.365 8.33235L19.6096 8.2998L19.5919 6.9165L19.5741 5.5332H18.1972H16.8203L16.8025 6.9165ZM0 12.466V13.8655H1.37957H2.75914V12.466V11.0664H1.37957H0V12.466ZM19.6214 20.8412C19.6429 23.8967 19.6652 26.4028 19.6709 26.4104C19.6766 26.418 20.3696 25.7627 21.211 24.9542C22.0522 24.1457 22.764 23.5097 22.7925 23.5408C22.8211 23.572 23.4727 24.6813 24.2406 26.006C25.0085 27.3307 25.6701 28.4482 25.7108 28.4892C25.7662 28.5451 26.086 28.3906 26.9818 27.8754L28.1789 27.187L28.0576 26.9871C27.0035 25.2481 25.231 22.1051 25.2856 22.0717C25.3239 22.0482 26.2205 21.7858 27.2781 21.4883C28.3357 21.191 29.2229 20.9274 29.2499 20.9026C29.2918 20.864 20.004 15.4458 19.6945 15.3284C19.589 15.2884 19.5846 15.6194 19.6214 20.8412ZM0 18.0317V19.3987H1.37957H2.75914V18.0317V16.6647H1.37957H0V18.0317Z"
                              fill="white"
                              fill-opacity="0.2"
                            />
                          </svg>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>
  }
  @if (isModalOpen()) {
    <app-season-characters-modal
      [forcedElements]="[]"
      [allCharacters]="availableCharacters()"
      [specialGuest]="specialGuestCharacters()"
      [startSelection]="usersCharacter()"
      [type]="'lineup'"
      [title]="'Please select Alternate Cast'"
      [min]="activeMode()?.min_characters || 0"
      [max]="activeMode()?.max_characters || 0"
      (close)="closeModal()"
      (save)="onSaveAlternateCast($event)"
    ></app-season-characters-modal>
  }
</section>
